name: compile pdf

on: push

jobs:
  convert_via_pandoc:
    runs-on: ubuntu-20.04
    container: 
      image: pandoc/latex:latest-ubuntu

    steps:
      # checkout repo contents
      - uses: actions/checkout@v4

      - name: install python
        run: |
          apt-get update && apt-get install python3 python3-pip git-all -y && ln -s /usr/bin/python3 /usr/bin/python

      - name: get xnos
        run: python -m pip install --force-reinstall --root-user-action=ignore --break-system-packages git+https://github.com/tomduck/pandoc-xnos@284474574f51888be75603e7d1df667a0890504d#egg=pandoc-xnos 

      # run pandoc to generate pdf from markdown
      - name: compile with pandoc
        run: |
          RETRIES=5
          pandoc_cmd="pandoc --verbose --filter pandoc-xnos --citeproc ./src/input.md --bibliography ./src/assets/bibtex.bib --csl ./src/template/apa.csl -o output.pdf --template ./src/template/imperial.tex"

          i=1
          while [ $i -le $RETRIES ]; do
            echo "Attempt $i..."
            sh -c "$pandoc_cmd" && break

            # If the command fails, look for missing LaTeX packages in the log
            missing_pkg=$(grep -oP "(?<=\`).+\.sty(?=\`)" /tmp/tex2pdf.*/*.log | sed 's/\.sty//')

            if [ -n "$missing_pkg" ]; then
              echo "Missing package detected: $missing_pkg"
              tlmgr install "$missing_pkg"
            else
              echo "No more missing packages detected, or another error occurred."
              exit 1
            fi

            i=$((i + 1))
          done

      # output generated file to build artifacts
      - uses: actions/upload-artifact@v3
        with:
          name: output
          path: "output.pdf"